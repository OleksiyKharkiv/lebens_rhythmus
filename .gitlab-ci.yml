variables:
  REGISTRY: "$CI_REGISTRY"
  REGISTRY_USER: "$CI_REGISTRY_USER"
  REGISTRY_PASS: "$CI_REGISTRY_PASSWORD"
  BACKEND_IMAGE: "$CI_REGISTRY_IMAGE/backend"
  FRONTEND_IMAGE: "$CI_REGISTRY_IMAGE/frontend"
  KUBECONFIG: "/tmp/kubeconfig"        # helm too

stages:
  - build
  - package
  - deploy
  - smoke

# ---------- 1. Build JAR ----------
build-backend:
  stage: build
  image: gradle:8.5-jdk21
  script:
    - cd backend
    - chmod +x ./gradlew
    - ./gradlew bootJar --no-daemon --build-cache
  artifacts:
    paths:
      - backend/build/libs/*.jar
    expire_in: 1 hour

# ---------- 2. Make Docker-image ----------
docker-backend:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  needs: [ build-backend ]
  script:
    - cd backend
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $REGISTRY
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push  $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA
    # latest – чтобы не менять тег каждый раз в values
    - docker tag $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA $BACKEND_IMAGE:latest
    - docker push $BACKEND_IMAGE:latest

docker-frontend:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  script:
    - cd frontend
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $REGISTRY
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push  $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA $FRONTEND_IMAGE:latest
    - docker push $FRONTEND_IMAGE:latest

deploy-dev:
  stage: deploy
  image:
    name: dtzar/helm-kubectl:3.18.3  # ✅ Тот же образ что в workout-evo
  needs: [ docker-backend, docker-frontend ]
  tags:
    - lr-runner
  before_script:
    # Copy kubeconfig from CI/CD variables
    - echo "$KUBECONFIG_FILE" | base64 -d > $KUBECONFIG
    - export KUBECONFIG=$KUBECONFIG
    - kubectl cluster-info
    - kubectl get nodes
  script:
    - |
      # 1. Create namespace if not exists
      if ! kubectl get namespace "lr-dev" >/dev/null 2>&1; then
        kubectl create namespace "lr-dev"
      fi

      # 2. Create Docker registry secret using YOUR variables
      kubectl create secret docker-registry gitlab-registry \
        --docker-server="registry.gitlab.com" \
        --docker-username="$REGISTRY_USER" \
        --docker-password="$REGISTRY_PASS" \
        --docker-email="hudoshin7605@gmail.com" \
        -n "lr-dev" \
        --dry-run=client -o yaml | kubectl apply -f -

      # 3. Deploy with Helm
      helm upgrade --install lr-dev ./devops/helm/lr-app \
        --namespace lr-dev \
        --set global.imageRegistry=registry.gitlab.com \
        --set backend.image.repository=okh3/lebens_rhythmus/backend \
        --set frontend.image.repository=okh3/lebens_rhythmus/frontend \
        --set global.imageTag=$CI_COMMIT_SHORT_SHA \
        --set postgres.db=lebens_rhythmus \
        --set postgres.storage=10Gi \
        --timeout=10m

      # 4. Wait for PostgreSQL to be ready
      echo "Waiting for PostgreSQL to be ready..."
      kubectl wait --for=condition=ready pod -l app=lr-postgres -n lr-dev --timeout=300s

      # 5. Wait for backend to be ready
      echo "Waiting for Backend to be ready..."
      kubectl wait --for=condition=ready pod -l app=lr-backend -n lr-dev --timeout=300s

      # 6. Wait for frontend to be ready  
      echo "Waiting for Frontend to be ready..."
      kubectl wait --for=condition=ready pod -l app=lr-frontend -n lr-dev --timeout=300s
# ---------- 4. Smoke-test ----------
smoke-test:
  stage: smoke
  image: curlimages/curl:latest
  needs: [ deploy-dev ]
  script:
    - curl -f https://api.tlab29.com/actuator/health || exit 1
    - curl -f https://tlab29.com || exit 1
  tags:
    - lr-runner